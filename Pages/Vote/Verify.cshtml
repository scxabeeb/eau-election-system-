@page
@model StudentElectionSystem.Pages.Vote.VerifyModel

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Student Face Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">

            <div class="card shadow border-0">
                <div class="card-body p-4 text-center">

                    <h4 class="mb-3">üßë‚Äçüéì Face Verification</h4>
                    <p class="text-muted">
                        Click Start Camera and look directly at the camera.
                        Guji Start Camera kadibna si toos ah ugu fiiri kamaradda. üì∑
                    </p>

                    <form method="post">

                        <!-- Start Camera Button -->
                        <div class="mb-3" id="startBox">
                            <button type="button"
                                    class="btn btn-primary w-100"
                                    onclick="startCamera()">
                                Start Camera
                            </button>
                        </div>

                        <!-- Camera -->
                        <div class="mb-3 d-none" id="cameraBox">
                            <video id="video"
                                   class="w-100 rounded border"
                                   autoplay
                                   playsinline></video>
                        </div>

                        <!-- Preview -->
                        <div class="mb-3 d-none" id="previewBox">
                            <h6>Captured Photo:</h6>
                            <img id="previewImage"
                                 class="img-fluid rounded border shadow" />
                        </div>

                        <!-- Student ID -->
                        <div class="mb-3 text-start d-none" id="idBox">
                            <label class="form-label">Student ID</label>
                            <input asp-for="StudentId"
                                   class="form-control"
                                   required />
                        </div>

                        <!-- Hidden Canvas -->
                        <canvas id="canvas" class="d-none"></canvas>

                        <!-- Hidden Image -->
                        <input type="hidden"
                               asp-for="CapturedImage"
                               id="CapturedImage" />

                        <!-- Continue -->
                        <div class="d-grid d-none" id="continueBox">
                            <button class="btn btn-success btn-lg">
                                Continue to Verification
                            </button>
                        </div>

                    </form>

                    @if (Model.Error != null)
                    {
                        <div class="alert alert-danger mt-3">
                            @Model.Error
                        </div>
                    }

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const video = document.getElementById("video");
    const previewBox = document.getElementById("previewBox");
    const previewImage = document.getElementById("previewImage");
    const idBox = document.getElementById("idBox");
    const continueBox = document.getElementById("continueBox");
    const cameraBox = document.getElementById("cameraBox");
    const startBox = document.getElementById("startBox");
    const canvas = document.getElementById("canvas");

    let streamRef;

    async function startCamera() {

        try {
            streamRef = await navigator.mediaDevices.getUserMedia({
                video: true
            });

            video.srcObject = streamRef;

            startBox.classList.add("d-none");
            cameraBox.classList.remove("d-none");

            video.onloadedmetadata = () => {
                setTimeout(capturePhoto, 2000);
            };

        } catch (error) {
            alert("Camera access denied or not available.");
        }
    }

    function capturePhoto() {

        if (!video.videoWidth) {
            alert("Camera not ready. Try again.");
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0);

        const imageData = canvas.toDataURL("image/png");
        document.getElementById("CapturedImage").value = imageData;

        previewImage.src = imageData;
        previewBox.classList.remove("d-none");

        cameraBox.classList.add("d-none");

        streamRef.getTracks().forEach(track => track.stop());

        idBox.classList.remove("d-none");
        continueBox.classList.remove("d-none");
    }
</script>

</body>
</html>
